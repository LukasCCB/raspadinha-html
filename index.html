<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raspadinha</title>
<style>
  body { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f7f7f7; }
  #game-container { position: relative; width: 600px; height: 600px; }
  #grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }
  .cell { display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 14px; color: #333; border: 1px solid #ddd; }
  .cell img { width: 60px; height: 60px; }
  #scratch { position: absolute; top: 0; left: 0; z-index: 1; }
  #result { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; background: rgba(255,255,255,0.9); padding: 10px; display: none; }
</style>
</head>
<body>

<div id="game-container">
  <div id="grid"></div>
  <canvas id="scratch" width="600" height="600"></canvas>
  <div id="result"></div>
</div>

<script>
    const items = [
  { title: "Carro", img: "üöó" },
  { title: "Viagem", img: "‚úàÔ∏è" },
  { title: "Dinheiro", img: "üí∞" }
];

const gameId = crypto.randomUUID();
const rtp = 30; // chance de vit√≥ria %
const gridEl = document.getElementById("grid");
const resultEl = document.getElementById("result");

let revealedPixels = 0;
let totalPixels = 600 * 600;
let revealedPercent = 0;
let gameOver = false;

// Gera grid com base no RTP
const gridData = Array(9).fill(null);
const win = Math.random() * 100 < rtp;
const winningItem = win ? items[Math.floor(Math.random() * items.length)] : null;

for (let i = 0; i < 9; i++) {
  if (win && i < 3) {
    gridData[i] = winningItem;
  } else {
    gridData[i] = items[Math.floor(Math.random() * items.length)];
  }
}
shuffle(gridData);

// Renderiza grid
gridData.forEach((cell, idx) => {
  const div = document.createElement("div");
  div.className = "cell";
  div.dataset.item = cell.title;
  div.innerHTML = `<div style="font-size:3rem">${cell.img}</div><div>${cell.title}</div>`;
  gridEl.appendChild(div);
});

// Configura canvas
const canvas = document.getElementById("scratch");
const ctx = canvas.getContext("2d");

// Desenha camada opaca + logo
ctx.fillStyle = "#aaa";
ctx.fillRect(0, 0, canvas.width, canvas.height);
ctx.globalAlpha = 0.5;
ctx.font = "48px Arial";
ctx.fillStyle = "#fff";
ctx.textAlign = "center";
ctx.fillText("LOGO", 300, 320);
ctx.globalAlpha = 1;

canvas.addEventListener("pointermove", e => {
  if (gameOver || e.buttons !== 1) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath();
  ctx.arc(x, y, 30, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalCompositeOperation = "source-over";

  revealedPixels++;
  revealedPercent = getRevealedPercent();
  if (revealedPercent >= 80 && !gameOver) {
    endGame();
  }
});

// Calcula % revelada
function getRevealedPercent() {
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  let cleared = 0;
  for (let i = 3; i < imgData.length; i += 4) {
    if (imgData[i] === 0) cleared++;
  }
  return ((cleared / (canvas.width * canvas.height)) * 100).toFixed(0);
}

// Finaliza jogo
function endGame() {
  gameOver = true;
  canvas.style.pointerEvents = "none";

  const counts = {};
  gridData.forEach(c => {
    counts[c.title] = (counts[c.title] || 0) + 1;
  });
  const isWin = Object.values(counts).some(v => v >= 3);

  resultEl.textContent = isWin ? "üéâ Vit√≥ria!" : "üòû Derrota!";
  resultEl.style.display = "block";

  console.log({
    gameId,
    result: isWin ? "vit√≥ria" : "derrota",
    grid: gridData.map(c => c.title),
    revealedPercent
  });
}

// Embaralha
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

</script>

</body>
</html>
